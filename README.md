 # 电机效率统一分析系统

## 1. 系统概述

本系统是一个基于Python和PyQt6构建的电机效率分析平台，旨在提供一个综合性的工具，用于精确测量和分析直流永磁电机的效率特性。系统核心功能包括传统的双机标定法（用于获取电机基础效率参数）以及一个灵活的批量实验分析模块，该模块允许用户系统地探究单一因素（如驱动电压/转速、负载电阻、永磁体磁场距离）对发电机效率的影响。

本系统采用图形用户界面（GUI），简化了数据导入、参数配置、实验执行和结果可视化的流程。它能够处理高频采样数据，并提供详细的计算结果、图表展示以及报告导出功能。

## 2. 核心特点

-   **双机标定实验模块**：
    -   **经典测量方法**：基于两台相同电机，通过正接和反接运行，精确计算单个电机的基础效率（包括验证效率和理论效率）。
    -   **综合参数分析**：提供正向效率、反向效率和综合效率的计算。
    -   **多通道数据处理**：能够分析数据采集器记录的多个通道数据。
-   **批量实验分析模块（因素探究）**：
    -   **统一单文件模式**：针对不同因素（输入电压、负载电阻、磁场距离）的探究，每组实验条件仅需单个数据文件。
    -   **复用验证逻辑**：计算效率时，将单个数据文件“同时”用于模拟双机标定中的正接和反接过程（通过 `calculate_unified_efficiencies` 函数实现），并提取其“验证实验”部分的“综合效率”作为该因素点的最终考察效率。
    -   **专注发电机输出**：分析主要基于AIN1和AIN2通道（通常对应发电机输出的电压和电流信号）的数据。
    -   **灵活参数配置**：用户可在表格中为每个因素点配置其可变参数值及对应的驱动电机平均输入功率。
    -   **结果可视化**：自动生成效率随所探究因素变化的曲线图，并标记最高效率点；同时提供平均输出功率的对比柱状图。
    -   **数据与配置管理**：支持将批量分析结果导出为Excel表格，实验配置可保存为JSON文件以便复现。
-   **技术特性**：
    -   **高频数据支持**：设计时考虑了高采样率数据（如87.5kHz）。
    -   **图形用户界面**：基于PyQt6，提供直观的用户交互。
    -   **数据可视化**：使用Matplotlib动态绘制电流、功率、效率曲线。
    -   **日志记录**：关键操作和潜在错误会记录在界面下方的日志区域。

## 3. 系统架构

### 3.1 硬件配置建议 (参考)
-   两台相同型号的微型直流永磁电机（例如 30W/12V）。
-   多功能数据采集器（如DAQ331M或类似设备，能够多通道同步采样）。
-   电流采样模块（如基于霍尔效应的传感器，将电流信号转换为电压信号）。
-   可调直流电源（例如 30V/5A）。
-   滑动变阻器或其他可调负载。
-   联轴器。

### 3.2 软件组成
-   **`unified_app.py`**: PyQt6图形用户界面程序。负责用户交互、参数输入、调用计算模块、展示结果和图表。
-   **`unified_calculator.py`**: 核心计算引擎。
    -   包含 `calculate_unified_efficiencies` 函数：用于双机标定实验的完整效率计算（包括验证和理论部分）。在批量因素探究模式下，通过传入相同文件路径给正接和反接参数，巧妙复用其验证实验的计算逻辑。
    -   包含 `ExperimentConfig` 类：管理和配置批量实验的参数。
    -   包含 `BatchExperimentAnalyzer` 类：执行批量实验的运行、结果汇总和图表数据生成（其绘图功能主要由UI层接管）。
-   **`README.md`**: 本说明文档。

## 4. 实验原理简述

### 4.1 双机标定法 (用于“双机标定实验”标签页)
此方法用于测定单个电机的效率。假设两台电机完全相同，效率均为η。
1.  **正接运行 (Motor A驱动Motor B)**：测得系统效率 η<sub>zheng</sub> = P<sub>B_out</sub> / P<sub>A_in</sub>。在理想情况下，如果只考虑电机转换效率，P<sub>A_out_mech</sub> = η * P<sub>A_in</sub>，P<sub>B_out</sub> = η * P<sub>B_in_mech</sub>。且 P<sub>B_in_mech</sub> = P<sub>A_out_mech</sub>。所以 η<sub>zheng_ideal</sub> = η²。
2.  **反接运行 (Motor B驱动Motor A)**：测得系统效率 η<sub>fan</sub> = P<sub>A_out</sub> / P<sub>B_in</sub>。同理，η<sub>fan_ideal</sub> = η²。
3.  **单机验证效率 (综合)**：η<sub>finished_verification</sub> = (η<sub>verification_zheng</sub> * η<sub>verification_fan</sub>)<sup>0.5</sup>。
    其中，验证实验的效率计算基于平均输入功率法： P<sub>out_gen</sub> / P<sub>in_motor_avg</sub>。

### 4.2 因素探究实验的效率计算 (用于“批量实验分析”标签页)
-   **单数据文件**：每个实验点（对应一个因素值）使用一个 `.csv` 数据文件。
-   **复用双机验证逻辑**：该数据文件被同时作为 `calculate_unified_efficiencies` 函数的“正接”和“反接”输入。
-   **提取验证综合效率**：从 `calculate_unified_efficiencies` 返回结果的 `["verification"]["finished_efficiency"]` 中获取的效率值即为该因素点的最终效率。这等效于用同一个数据集计算两次“验证实验效率”，然后取其几何平均值，实际上就是该数据集基于AIN1/2（通常是发电机输出电流对应的通道）计算出的发电机效率。
-   **输入功率**：计算效率时所需的分母（输入能量）依赖于用户在批量实验参数表格中为该因素点指定的“平均输入功率(W)”。

## 5. 软件设计与使用

### 5.1 环境要求
-   Python >= 3.8 (推荐3.10+)
-   pandas
-   numpy
-   PyQt6
-   matplotlib
-   openpyxl (用于导出Excel)

可通过 `pip install pandas numpy PyQt6 matplotlib openpyxl` 安装。

### 5.2 “电机效率统一分析系统QT界面”简介

本软件基于PyQt6构建，提供了一个用户友好的图形界面，主要包含两大核心功能模块，分别对应界面上的两个主标签页：

#### 5.2.1 核心功能：双机标定实验模块 (Tab: "🔄 双机标定实验")

-   **主要用途**:
    -   执行传统的双机标定实验，用以精确评估单个直流永磁电机的各项效率指标。
    -   此模块中设置的“实验参数”（如电流传感器校准值、负载电阻、采样频率）将作为“批量实验分析”模块进行因素探究时的基础通用参数。
-   **操作流程与特性**:
    1.  **数据文件导入**: 用户需分别导入“正接实验”和“反接实验”的 `.csv` 数据文件。
    2.  **实验参数配置**: 
        -   `电流比例值 (A/V)` (reference_v): 电流传感器输出电压与实际电流的转换比例。
        -   `基准电压 (V)` (initial_v): 电流传感器在零电流时的输出电压偏置。
        -   `负载电阻 R (Ω)` (r_load): 连接在发电机输出端的负载电阻值。
        -   `驱动电压 (V)` (drive_v): **理论实验**部分计算驱动电机输入功率时使用的电压值（在验证实验中不直接使用此输入框的值作为输入功率的电压）。
        -   `平均输入功率 (W)` (power_input): **验证实验**中，驱动电机的平均总输入电功率。此值通常需要通过外部功率计或电压电流表在实验过程中测量得到。
        -   `采样频率 (Hz)` (sampling_freq): 数据采集设备（如DAQ卡、示波器）的采样频率。
        -   `数据点处理 (可选)`: 允许用户指定只处理每个数据文件的前N个数据点，便于快速分析或去除启动/停止阶段的非稳态数据。
    3.  **计算执行**: 点击“🧮 开始统一计算”按钮后，系统将调用 `calculate_unified_efficiencies` 函数进行处理。
    4.  **结果展示**:
        -   **效率结果表格**: 清晰列出“验证实验”（基于平均输入功率法）和“理论实验”（基于实时输入输出功率积分法，依赖AIN5-7等通道）各自的正向效率、反向效率和最终综合效率。同时显示两种方法间的差异和差异率。
        -   **数据统计表格**: 提供所有8个AIN通道（如果数据文件中包含）在正接和反接数据中的最大值、最小值和平均值统计。
        -   **图表分析标签页**: 
            -   *电流对比*: 绘制验证实验和理论实验中关键电流（如发电机输出电流、驱动电机输入电流等）随时间变化的曲线。
            -   *功率对比*: 绘制相应的功率曲线。
            -   *效率对比*: 以柱状图形式直观比较不同计算方法下的各项效率指标。
    5.  **报告导出**: 可点击“📄 导出分析报告”将详细的实验参数、计算结果和差异分析保存为文本文件。
    6.  **原理说明**: 提供实验原理和通道分配等辅助信息。

#### 5.2.2 核心功能：批量实验分析模块 (Tab: "🔍 批量实验分析")

-   **主要用途**:
    -   系统地研究单一可变因素（如输入电压/转速、负载电阻、永磁体与线圈的磁场距离）对发电机效率的影响规律。
-   **操作流程与特性**:
    1.  **探究类型选择**: 
        -   `输入电压影响`: 模拟改变驱动电机供电电压，进而影响转速和输入功率的情况。
        -   `负载电阻影响`: 改变发电机输出端连接的负载电阻大小。
        -   `磁场距离影响`: 改变永磁体位置，从而调整气隙磁场强度。
    2.  **实验参数配置 (表格形式)**:
        -   用户可添加多行，每行代表一个实验点（一个特定的因素值）。
        -   **第一列（变量值）**：根据所选探究类型，输入相应的变量值（如电压值、电阻值、距离值）。
        -   **第二列（输入功率(W)）**：**此列至关重要！** 用户必须为**每一个实验点**填写对应的**驱动电机的平均输入电功率**。这个值直接影响效率计算的准确性。
    3.  **数据文件设置**:
        -   **模式**: 所有探究类型均采用**单文件模式**，即每个实验点（表格中的每一行）对应一个独立的 `.csv` 数据文件。
        -   **文件选择方式一 (推荐)**: 点击“📂 批量选择数据文件”，一次性选择所有相关的数据文件。程序会按文件名排序，并假定其顺序与参数表格中的行顺序一致。
        -   **文件选择方式二 (命名模式)**: 在“文件命名模式”输入框中提供包含 `{index}` 占位符的文件路径模式（例如 `data/my_exp_{index}`，程序会自动添加 `.csv` 后缀并替换 `{index}` 为1, 2, 3...）。
    4.  **计算逻辑**: 
        -   点击“🧮 运行批量分析”。
        -   程序会遍历参数表格中的每一行（或匹配到的文件）。
        -   对于每个实验点，它将调用 `calculate_unified_efficiencies` 函数，并将对应的**单个数据文件路径同时作为“正接文件”和“反接文件”参数传入**。这种方式巧妙地复用了“验证实验”部分的计算逻辑。
        -   **参数传递**: 
            -   `reference_v`, `initial_v`, `sampling_freq` 以及非电阻探究时的 `r_load`，均继承自“双机标定实验”标签页的“实验参数设置”中的值。
            -   表格中填写的“变量值”会用于设置相应的参数（如 `drive_v` 或 `r_load`）。
            -   表格中填写的“输入功率(W)”会作为 `power_input` 传递给计算函数。
        -   **效率提取**: 计算得到的 `result["verification"]["finished_efficiency"]` 被视为该因素点的最终效率。
    5.  **结果展示**:
        -   **结果对比表**: 详细列出每个实验组的序号、变量值、输入功率(W)、计算得到的效率(%)、平均输出功率(W)、最大输出功率(W)，以及该组效率相对于第一组效率的百分比变化。
        -   **效率曲线图 (📈 效率曲线 Tab)**: 动态绘制效率随所探究因素变化的曲线图，并自动高亮标记出效率最高的实验点。
        -   **功率分析图 (⚡ 功率分析 Tab)**: 以柱状图形式展示不同因素值（实验组）下的平均输出功率。
    6.  **配置管理与导出**:
        -   “📊 导出对比表格”: 将结果表格中的数据导出为 `.xlsx` (Excel) 文件，其中包含结果数据和本次实验的配置信息两个工作表。
        -   “💾 保存配置”/ “📥 加载配置”: 允许用户将当前的批量实验设置（探究类型、参数表、文件模式等）保存到JSON文件，或从JSON文件加载，方便重复实验和共享配置。

### 5.3 数据格式与通道约定

#### CSV 文件格式
-   纯文本文件，逗号分隔值 (CSV)。
-   程序默认跳过第一行 (通常为表头)。
-   **第一列 (索引0)**: 时间戳或序列号 (程序内部会根据采样频率生成时间序列)。
-   **第三列 (索引2)**: **AIN2 通道数据**。在“批量实验分析”模块中，此列数据被用作计算发电机输出电流的基础（经过 `initial_v` 和 `reference_v` 校准后）。
    ```csv
    Timestamp,AIN1,AIN2,AIN3,AIN4,AIN5,AIN6,AIN7,AIN8
    0.000,2.5,2.75824,0.0,0.0,2.5,2.5,2.5,0.0
    0.0000114286,2.5,2.71795,0.0,0.0,2.5,2.5,2.5,0.0
    ...
    ```

#### 通道使用说明
-   **“双机标定实验”模块**:
    -   验证实验部分：主要使用 **AIN2** (假定为发电机输出电流对应的电压信号) 和 **AIN1** (如果用于电压，但当前脚本主要基于AIN2算电流，再用R算功率)。
    -   理论实验部分：会尝试使用 **AIN5, AIN6, AIN7** (通常对应理论模型中的发电机输出和驱动电机输入参数)。
-   **“批量实验分析”模块** (所有因素探究类型):
    -   **只使用 AIN2 通道数据** (CSV文件的第3列) 来计算发电机的输出电流，进而计算输出功率和效率。
    -   AIN1和其他通道的数据在该模式下不被用于核心效率计算。

### 5.4 注意事项
1.  **参数准确性**：所有输入参数的准确性对计算结果至关重要。特别注意：
    -   “双机标定实验”页面的 `reference_v`, `initial_v`, `r_load`, `sampling_freq`。
    -   “批量实验分析”页面表格中，为**每一组**实验条件填写的 `输入功率(W)`。此值应为**驱动电机**在该特定条件下的**实际平均输入电功率**。
2.  **负载电阻 `r_load` 的来源**: 
    -   在“批量实验分析”中进行“输入电压影响”或“磁场距离影响”探究时，计算所用的 `r_load` 值来自“双机标定实验”页面的参数设置。
    -   在探究“负载电阻影响”时，`r_load` 值由批量实验表格的第一列（变量值）决定。
3.  **文件与参数的对应**：进行批量分析时，确保选择的数据文件数量、顺序与参数表格中的行数和顺序一致。
4.  **数据质量**：原始数据文件中的噪声、漂移或异常值可能显著影响计算结果的准确性。

### 5.5 故障排除与常见问题
1.  **效率计算结果 > 100% 或显著不合理**:
    -   **首要检查**: 在“批量实验分析”中，为每个实验点填写的“输入功率(W)”是否准确反映了**驱动电机**在该条件下的**实际平均输入功率**。如果此值填写过小，计算出的效率会异常偏高。
    -   **核对负载电阻 `r_load`**：确保“双机标定实验”页面设置的 `r_load` 与您进行批量实验（特别是电压和磁场距离探究）时的物理负载一致。
    -   **检查电流传感器参数**：`reference_v` 和 `initial_v` 是否已正确校准并输入。
    -   检查数据文件中AIN2通道的数据是否正确反映了发电机的输出信号，并且数值范围合理。
2.  **文件未找到/不完整警告**:
    -   使用“批量选择文件”时，确保所有预期的文件都已选中。
    -   使用“文件命名模式”时，仔细检查模式字符串是否正确，路径是否存在，且文件是否按照 `{index}` (从1开始) 规则命名 (如 `data/exp_1.csv`, `data/exp_2.csv` ...)。
3.  **计算失败或错误弹窗**:
    -   检查CSV文件格式，确保数据列为纯数字，并且分隔符为逗号。
    -   查看控制台和软件界面下方的“系统日志”区域，获取详细的错误信息。
4.  **界面无响应**: 如果处理非常大的数据文件或非常多的实验组，程序可能会在计算期间暂时无响应。可以考虑使用“数据点处理”（在双机标定页面）功能截取一部分数据进行初步分析，或分批进行批量实验。

## 6. 未来展望 (可选)
-   增加更高级的数据预处理选项（如噪声滤波、基线校正）。
-   支持更多类型的拟合曲线和统计分析。
-   集成电机参数（如内阻、反电动势常数）的辨识功能。
-   提供更灵活和详细的报告定制选项。
